name: üöÄ WhatsDeX AI Bot - Production CI/CD Pipeline

on:
  push:
    branches: [main, production]
    tags: ['v*']
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      deployment_target:
        description: 'Deployment Target'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
        - aws
        - gcp
        - azure
      deployment_strategy:
        description: 'Deployment Strategy'
        required: true
        default: 'blue-green'
        type: choice
        options:
        - blue-green
        - rolling
        - canary
        - fresh

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  NODE_VERSION: '18'
  DOCKER_BUILDKIT: 1

jobs:
  # ================================================
  # CODE QUALITY & TESTING
  # ================================================
  quality-checks:
    name: üîç Code Quality & Security
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      should-deploy: ${{ steps.changes.outputs.should-deploy }}
    
    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: üìã Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: üì¶ Install Dependencies
      run: |
        npm ci
        cd web && npm ci
    - name: üîê Export OWNER_NUMBER to env
      run: echo "OWNER_NUMBER=${{ secrets.OWNER_NUMBER }}" >> $GITHUB_ENV
    
    - name: üîç ESLint Check
      run: |
        npm run lint
        cd web && npm run lint
    
    - name: üß™ Run Tests
      run: |
        npm run test:ci
        cd web && npm run test:ci
    
    - name: üîí Security Audit
      run: |
        npm audit --audit-level=high
        cd web && npm audit --audit-level=high
    
    - name: üìä Code Coverage
      uses: codecov/codecov-action@v3
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./coverage/lcov.info,./web/coverage/lcov.info
    
    - name: üè∑Ô∏è Generate Version
      id: version
      run: |
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
        else
          VERSION="v$(date +%Y%m%d)-$(git rev-parse --short HEAD)"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Generated version: $VERSION"
    
    - name: üîÑ Check for Changes
      id: changes
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]] || [[ "${{ github.ref }}" == "refs/heads/main" ]] || [[ $GITHUB_REF == refs/tags/* ]]; then
          echo "should-deploy=true" >> $GITHUB_OUTPUT
        else
          echo "should-deploy=false" >> $GITHUB_OUTPUT
        fi

  # ================================================
  # AI INTELLIGENCE TESTING
  # ================================================
  ai-testing:
    name: üß† AI Intelligence Testing
    runs-on: ubuntu-latest
    needs: quality-checks
    if: needs.quality-checks.outputs.should-deploy == 'true'
    
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v4
    
    - name: üìã Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: üì¶ Install Dependencies
      run: npm ci
    
    - name: üß† Test AI Brain Components
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY_TEST }}
        REDIS_HOST: localhost
        REDIS_PORT: 6379
        NODE_ENV: test
      run: |
        npm run test:ai-brain
        npm run test:intelligent-processor
        npm run test:tool-registry
    
    - name: üìä Test Analytics System
      env:
        REDIS_HOST: localhost
        REDIS_PORT: 6379
        NODE_ENV: test
      run: |
        npm run test:analytics
        npm run test:engagement-tracker
    
    - name: üîÑ Integration Tests
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY_TEST }}
        REDIS_HOST: localhost
        REDIS_PORT: 6379
        NODE_ENV: test
      run: npm run test:integration

  # ================================================
  # DOCKER BUILD & PUSH
  # ================================================
  build-images:
    name: üê≥ Build & Push Docker Images
    runs-on: ubuntu-latest
    needs: [quality-checks, ai-testing]
    if: needs.quality-checks.outputs.should-deploy == 'true'
    
    strategy:
      matrix:
        component: [bot, web, nginx]
    
    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v4
    
    - name: üê≥ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: üîê Login to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: üìã Extract Metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-${{ matrix.component }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=raw,value=latest,enable={{is_default_branch}}
          type=raw,value=${{ needs.quality-checks.outputs.version }}
    
    - name: üèóÔ∏è Build and Push Docker Image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./deployment/dockerfiles/Dockerfile.${{ matrix.component }}
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          VERSION=${{ needs.quality-checks.outputs.version }}
          NODE_ENV=production
          AI_INTELLIGENCE_MODE=true
          ANALYTICS_ENABLED=true

  # ================================================
  # SECURITY SCANNING
  # ================================================
  security-scan:
    name: üîí Security Scanning
    runs-on: ubuntu-latest
    needs: build-images
    
    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v4
    
    - name: üîç Run Trivy Vulnerability Scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-bot:${{ needs.quality-checks.outputs.version }}
        format: 'sarif'
        output: 'trivy-results.sarif'
    
    - name: üìä Upload Trivy Scan Results
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-results.sarif'
    
    - name: üîê Run Snyk Security Scan
      uses: snyk/actions/node@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=high

  # ================================================
  # STAGING DEPLOYMENT
  # ================================================
  deploy-staging:
    name: üöÄ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [quality-checks, build-images, security-scan]
    if: github.ref == 'refs/heads/main' && needs.quality-checks.outputs.should-deploy == 'true'
    environment: staging
    
    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v4
    
    - name: üîß Setup Deployment Tools
      run: |
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        chmod +x kubectl
        sudo mv kubectl /usr/local/bin/
        
        curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
        chmod 700 get_helm.sh
        ./get_helm.sh
    
    - name: üéØ Deploy to Staging Environment
      env:
        KUBE_CONFIG: ${{ secrets.KUBE_CONFIG_STAGING }}
        IMAGE_TAG: ${{ needs.quality-checks.outputs.version }}
      run: |
        echo "$KUBE_CONFIG" | base64 -d > kubeconfig
        export KUBECONFIG=kubeconfig
        
        # Update image tags in manifests
        sed -i "s|:latest|:$IMAGE_TAG|g" deployment/kubernetes/*.yaml
        
        # Deploy to staging namespace
        kubectl apply -f deployment/kubernetes/whatsdx-namespace-staging.yaml
        kubectl apply -f deployment/kubernetes/ -n whatsdx-staging
        
        # Wait for deployment
        kubectl rollout status deployment/whatsdx-bot -n whatsdx-staging --timeout=600s
        kubectl rollout status deployment/whatsdx-web -n whatsdx-staging --timeout=600s
    
    - name: üß™ Run Staging Health Checks
      run: |
        # Wait for services to be ready
        sleep 60
        
        # Health check endpoints
        curl -f https://staging-api.yourdomain.com/api/health || exit 1
        curl -f https://staging-dashboard.yourdomain.com/api/health || exit 1
        
        # AI functionality test
        curl -X POST https://staging-api.yourdomain.com/api/test/ai \
          -H "Content-Type: application/json" \
          -d '{"message": "CI/CD test message"}' || exit 1
    
    - name: üìä Update Staging Status
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#deployments'
        webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        text: "üöÄ Staging deployment completed for version ${{ needs.quality-checks.outputs.version }}"

  # ================================================
  # PRODUCTION DEPLOYMENT APPROVAL
  # ================================================
  production-approval:
    name: ‚úÖ Production Deployment Approval
    runs-on: ubuntu-latest
    needs: [deploy-staging]
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
    environment: production-approval
    
    steps:
    - name: üìã Deployment Summary
      run: |
        echo "## üöÄ Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Version**: ${{ needs.quality-checks.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Staging Tests**: ‚úÖ Passed" >> $GITHUB_STEP_SUMMARY
        echo "- **Security Scan**: ‚úÖ Passed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Ready for production deployment! üéâ" >> $GITHUB_STEP_SUMMARY

  # ================================================
  # PRODUCTION DEPLOYMENT
  # ================================================
  deploy-production:
    name: üéØ Deploy to Production
    runs-on: ubuntu-latest
    needs: [quality-checks, production-approval]
    environment: production
    
    strategy:
      matrix:
        platform: [docker-compose, kubernetes, aws, gcp, azure]
        exclude:
          - platform: aws
            if: ${{ !contains(github.event.inputs.deployment_target, 'aws') }}
          - platform: gcp
            if: ${{ !contains(github.event.inputs.deployment_target, 'gcp') }}
          - platform: azure
            if: ${{ !contains(github.event.inputs.deployment_target, 'azure') }}
    
    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v4
    
    - name: üîß Setup Platform Tools
      run: |
        case "${{ matrix.platform }}" in
          "kubernetes"|"gcp"|"aws"|"azure")
            curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
            chmod +x kubectl && sudo mv kubectl /usr/local/bin/
            ;;
          "aws")
            curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
            unzip awscliv2.zip && sudo ./aws/install
            ;;
          "gcp")
            curl https://sdk.cloud.google.com | bash
            exec -l $SHELL
            ;;
          "azure")
            curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
            ;;
        esac
    
    - name: üöÄ Execute Platform-Specific Deployment
      env:
        IMAGE_TAG: ${{ needs.quality-checks.outputs.version }}
        DEPLOYMENT_STRATEGY: ${{ github.event.inputs.deployment_strategy || 'blue-green' }}
      run: |
        case "${{ matrix.platform }}" in
          "docker-compose")
            # Docker Compose deployment
            chmod +x deployment/deploy.sh
            ./deployment/deploy.sh $DEPLOYMENT_STRATEGY production
            ;;
          "kubernetes")
            # Kubernetes deployment
            echo "${{ secrets.KUBE_CONFIG_PROD }}" | base64 -d > kubeconfig
            export KUBECONFIG=kubeconfig
            ./deployment/k8s-deploy.sh $DEPLOYMENT_STRATEGY $IMAGE_TAG
            ;;
          "aws")
            # AWS EKS deployment
            aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
            aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            aws configure set default.region ${{ secrets.AWS_REGION }}
            aws eks update-kubeconfig --region ${{ secrets.AWS_REGION }} --name whatsdx-production
            ./deployment/aws/deploy.sh $DEPLOYMENT_STRATEGY $IMAGE_TAG
            ;;
          "gcp")
            # Google GKE deployment
            echo "${{ secrets.GCP_SA_KEY }}" | base64 -d > gcp-key.json
            gcloud auth activate-service-account --key-file gcp-key.json
            gcloud container clusters get-credentials whatsdx-production --zone ${{ secrets.GCP_ZONE }} --project ${{ secrets.GCP_PROJECT }}
            ./deployment/gcp/deploy.sh $DEPLOYMENT_STRATEGY $IMAGE_TAG
            ;;
          "azure")
            # Azure AKS deployment
            az login --service-principal -u ${{ secrets.AZURE_CLIENT_ID }} -p ${{ secrets.AZURE_CLIENT_SECRET }} --tenant ${{ secrets.AZURE_TENANT_ID }}
            az aks get-credentials --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} --name whatsdx-production
            ./deployment/azure/deploy.sh $DEPLOYMENT_STRATEGY $IMAGE_TAG
            ;;
        esac
    
    - name: üß™ Production Health Verification
      run: |
        sleep 120  # Allow time for deployment to complete
        
        # Health checks
        curl -f https://api.yourdomain.com/api/health || exit 1
        curl -f https://dashboard.yourdomain.com/api/health || exit 1
        
        # AI system check
        curl -X POST https://api.yourdomain.com/api/test/ai \
          -H "Content-Type: application/json" \
          -d '{"message": "Production deployment verification"}' || exit 1
        
        # Analytics system check
        curl -f https://dashboard.yourdomain.com/analytics-dashboard || exit 1
    
    - name: üìä Post-Deployment Metrics
      run: |
        # Trigger metrics collection
        curl -X POST https://api.yourdomain.com/api/analytics/deployment-event \
          -H "Content-Type: application/json" \
          -d '{
            "event": "deployment_completed",
            "version": "${{ needs.quality-checks.outputs.version }}",
            "platform": "${{ matrix.platform }}",
            "strategy": "${{ env.DEPLOYMENT_STRATEGY }}",
            "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
          }'

  # ================================================
  # POST-DEPLOYMENT VERIFICATION
  # ================================================
  post-deployment:
    name: üîç Post-Deployment Verification
    runs-on: ubuntu-latest
    needs: [deploy-production]
    
    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v4
    
    - name: üß™ Comprehensive System Testing
      run: |
        # Run comprehensive test suite against production
        npm ci
        npm run test:production-verification
    
    - name: üìä Performance Baseline
      run: |
        # Establish performance baseline
        curl -X POST https://api.yourdomain.com/api/analytics/baseline \
          -H "Content-Type: application/json" \
          -d '{"version": "${{ needs.quality-checks.outputs.version }}"}'
    
    - name: üö® Setup Monitoring Alerts
      run: |
        # Configure monitoring alerts for new deployment
        ./deployment/scripts/setup-alerts.sh "${{ needs.quality-checks.outputs.version }}"
    
    - name: üì¢ Deployment Notification
      uses: 8398a7/action-slack@v3
      with:
        status: custom
        custom_payload: |
          {
            "channel": "#deployments",
            "attachments": [{
              "color": "good",
              "title": "üéâ Production Deployment Successful!",
              "fields": [
                {"title": "Version", "value": "${{ needs.quality-checks.outputs.version }}", "short": true},
                {"title": "Platform", "value": "Multi-Platform", "short": true},
                {"title": "Strategy", "value": "${{ github.event.inputs.deployment_strategy || 'blue-green' }}", "short": true},
                {"title": "Duration", "value": "${{ steps.deployment-time.outputs.duration }}", "short": true}
              ],
              "footer": "WhatsDeX AI Bot CI/CD Pipeline",
              "ts": ${{ github.event.head_commit.timestamp }}
            }]
          }
        webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ================================================
  # ROLLBACK CAPABILITY
  # ================================================
  rollback:
    name: üîÑ Rollback Deployment
    runs-on: ubuntu-latest
    if: failure() && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))
    needs: [deploy-production]
    environment: production
    
    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v4
    
    - name: üîÑ Execute Rollback
      run: |
        # Get previous stable version
        PREVIOUS_VERSION=$(curl -s https://api.yourdomain.com/api/deployment/previous-version)
        
        # Execute rollback
        ./deployment/rollback.sh $PREVIOUS_VERSION
    
    - name: üö® Rollback Notification
      uses: 8398a7/action-slack@v3
      with:
        status: custom
        custom_payload: |
          {
            "channel": "#deployments",
            "attachments": [{
              "color": "warning",
              "title": "‚ö†Ô∏è Production Rollback Executed",
              "text": "Deployment failed and was automatically rolled back to previous stable version.",
              "footer": "WhatsDeX AI Bot CI/CD Pipeline"
            }]
          }
        webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}