// Multi-tenant WhatsDeX SaaS Database Schema
// Enums not supported in SQLite; use String with code validation
// Status values: "PENDING", "APPROVED", "REJECTED", "EXPIRED", "CANCELLED"
// RiskLevel values: "LOW", "MEDIUM", "HIGH", "CRITICAL"

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters", "postgresqlExtensions"]
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
  extensions        = [vector()] // Or your installed version
}

// Multi-tenancy: Customer Organizations
model Tenant {
  id               String    @id @default(cuid())
  name             String
  subdomain        String    @unique
  email            String    @unique
  phone            String?
  description      String?
  logo             String?
  website          String?
  status           String    @default("active") // active, suspended, cancelled
  plan             String    @default("free") // free, basic, pro, enterprise
  planLimits       String? // JSON of plan limits
  customSettings   String? // JSON of custom settings
  stripeCustomerId String?   @unique
  trialEndsAt      DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  tenantUsers   TenantUser[]
  botInstances  BotInstance[]
  subscriptions TenantSubscription[]
  payments      TenantPayment[]
  apiKeys       TenantApiKey[]
  analytics     TenantAnalytics[]
  auditLogs     TenantAuditLog[]
  usageCounters UsageCounter[]
  botTemplates  BotTemplate[]

  @@map("tenants")
}

// Tenant Users (Customer's team members)
model TenantUser {
  id            String    @id @default(cuid())
  tenantId      String
  tenant        Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  email         String
  name          String
  passwordHash  String
  role          String    @default("user") // admin, user, viewer
  avatar        String?
  permissions   String? // JSON of specific permissions
  isActive      Boolean   @default(true)
  lastLoginAt   DateTime?
  emailVerified Boolean   @default(false)
  invitedBy     String?
  invitedAt     DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  sessions  TenantUserSession[]
  auditLogs TenantAuditLog[]

  @@unique([tenantId, email])
  @@map("tenant_users")
}

// Tenant User Sessions
model TenantUserSession {
  id        String     @id @default(cuid())
  userId    String
  user      TenantUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessionId String     @unique
  ipAddress String?
  userAgent String?
  expiresAt DateTime
  createdAt DateTime   @default(now())

  @@map("tenant_user_sessions")
}

// WhatsApp Bot Instances per Tenant
model BotInstance {
  id           String    @id @default(cuid())
  tenantId     String
  tenant       Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name         String
  phoneNumber  String?
  qrCode       String?
  status       String    @default("disconnected") // connected, disconnected, scanning, error
  sessionData  String? // Encrypted session data
  config       String? // JSON bot configuration
  lastActivity DateTime?
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  users     BotUser[]
  groups    BotGroup[]
  messages  BotMessage[]
  analytics BotAnalytics[]
  settings  BotSettings?

  @@unique([tenantId, phoneNumber])
  @@map("bot_instances")
}

// Bot Users (WhatsApp users interacting with the bot)
model BotUser {
  id            String   @id @default(cuid())
  botInstanceId String
  jid           String // WhatsApp JID
  name          String?
  phone         String?
  avatar        String?
  role          String   @default("member") // member, admin, owner
  isBlocked     Boolean  @default(false)
  lastActivity  DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  botInstance BotInstance  @relation(fields: [botInstanceId], references: [id], onDelete: Cascade)
  messages    BotMessage[]

  @@unique([botInstanceId, jid])
  @@map("bot_users")
}

// Bot Groups
model BotGroup {
  id            String      @id @default(cuid())
  botInstanceId String
  botInstance   BotInstance @relation(fields: [botInstanceId], references: [id], onDelete: Cascade)
  jid           String
  name          String?
  description   String?
  memberCount   Int         @default(0)
  isActive      Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@unique([botInstanceId, jid])
  @@map("bot_groups")
}

// Bot Messages
model BotMessage {
  id            String      @id @default(cuid())
  botInstanceId String
  botInstance   BotInstance @relation(fields: [botInstanceId], references: [id], onDelete: Cascade)
  userId        String?
  user          BotUser?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  messageId     String
  fromJid       String
  toJid         String
  type          String // text, image, audio, video, document
  content       String?
  mediaUrl      String?
  command       String?
  isIncoming    Boolean     @default(true)
  timestamp     DateTime    @default(now())

  @@unique([botInstanceId, messageId])
  @@map("bot_messages")
}

// Tenant Subscriptions
model TenantSubscription {
  id                   String    @id @default(cuid())
  tenantId             String
  tenant               Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  stripeSubscriptionId String    @unique
  stripePriceId        String
  status               String // active, canceled, past_due, etc.
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean   @default(false)
  trialStart           DateTime?
  trialEnd             DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  plan                 Plan?     @relation(fields: [planId], references: [id])
  planId               String?

  @@map("tenant_subscriptions")
}

// Tenant Payments
model TenantPayment {
  id              String   @id @default(cuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  stripePaymentId String   @unique
  amount          Int // Amount in cents
  currency        String   @default("usd")
  status          String // succeeded, pending, failed
  description     String?
  invoiceUrl      String?
  receiptUrl      String?
  createdAt       DateTime @default(now())

  @@map("tenant_payments")
}

// Tenant API Keys
model TenantApiKey {
  id        String    @id @default(cuid())
  tenantId  String
  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name      String
  keyHash   String    @unique
  keyPrefix String
  lastUsed  DateTime?
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  expiresAt DateTime?

  @@map("tenant_api_keys")
}

// Tenant Analytics
model TenantAnalytics {
  id       String   @id @default(cuid())
  tenantId String
  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  metric   String
  value    Float
  metadata String? // JSON metadata
  date     DateTime @default(now())

  @@map("tenant_analytics")
}

// Bot Analytics
model BotAnalytics {
  id            String      @id @default(cuid())
  botInstanceId String
  botInstance   BotInstance @relation(fields: [botInstanceId], references: [id], onDelete: Cascade)
  metric        String
  value         Float
  metadata      String? // JSON metadata
  date          DateTime    @default(now())

  @@map("bot_analytics")
}

// Tenant Audit Logs
model TenantAuditLog {
  id         String      @id @default(cuid())
  tenantId   String
  tenant     Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userId     String?
  user       TenantUser? @relation(fields: [userId], references: [id], onDelete: SetNull)
  action     String
  resource   String
  resourceId String?
  details    String? // JSON details
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime    @default(now())

  @@map("tenant_audit_logs")
}

// User management
model User {
  id            String    @id @default(cuid())
  jid           String    @unique
  name          String?
  phone         String?
  email         String?
  avatar        String?
  xp            Int       @default(0)
  level         Int       @default(1)
  coin          Int       @default(0)
  premium       Boolean   @default(false)
  premiumExpiry DateTime?
  banned        Boolean   @default(false)
  banReason     String?
  lastActivity  DateTime  @default(now()) // Add index for queries
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  sessions               UserSession[]
  commands               CommandUsage[]
  groups                 UserGroup[]
  menfessFrom            Menfess[]               @relation("menfessFromUser")
  menfessTo              Menfess[]               @relation("menfessToUser")
  feedback               Feedback[]
  subscriptions          Subscription[]
  violations             UserViolation[]
  moderationQueues       ModerationQueue[]
  payments               Payment[]
  adminSessions          AdminSession[]
  ConversationMemory     ConversationMemory[]
  AIGeneratedContent     AIGeneratedContent[]
  ConversationEmbeddings ConversationEmbedding[] // New relation

  @@index([lastActivity])
  @@map("users")
}

model UserSession {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessionId String    @unique
  ipAddress String?
  userAgent String?
  platform  String?
  startedAt DateTime  @default(now())
  endedAt   DateTime?
  duration  Int? // in seconds

  @@map("user_sessions")
}

model CommandUsage {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  command       String
  category      String
  success       Boolean  @default(true)
  errorMessage  String?
  executionTime Int? // in milliseconds
  usedAt        DateTime @default(now())

  @@map("command_usage")
}

model Group {
  id          String   @id @default(cuid())
  jid         String   @unique
  name        String?
  description String?
  avatar      String?
  ownerJid    String?
  memberCount Int      @default(0)
  maxMembers  Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  users    UserGroup[]
  settings GroupSetting[]
  menfess  Menfess[]

  @@map("groups")
}

model UserGroup {
  id       String   @id @default(cuid())
  userId   String
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  groupId  String
  group    Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  role     String   @default("member") // member, admin, owner
  joinedAt DateTime @default(now())

  @@unique([userId, groupId])
  @@map("user_groups")
}

model GroupSetting {
  id           String   @id @default(cuid())
  groupId      String
  group        Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  settingKey   String
  settingValue String
  updatedBy    String
  updatedAt    DateTime @updatedAt

  @@unique([groupId, settingKey])
  @@map("group_settings")
}

model Menfess {
  id         String   @id @default(cuid())
  fromUserId String
  fromUser   User     @relation("menfessFromUser", fields: [fromUserId], references: [id], onDelete: Cascade)
  toGroupId  String?
  toGroup    Group?   @relation(fields: [toGroupId], references: [id], onDelete: Cascade)
  toUserId   String?
  toUser     User?    @relation("menfessToUser", fields: [toUserId], references: [id], onDelete: Cascade)
  message    String
  mediaUrl   String?
  mediaType  String?
  sentAt     DateTime @default(now())
  delivered  Boolean  @default(false)
  read       Boolean  @default(false)

  @@map("menfess")
}

model BotSetting {
  id          String   @id @default(cuid()) @map("id") @db.Uuid
  key         String   @unique
  value       String
  category    String
  description String?
  updatedBy   String
  updatedAt   DateTime @updatedAt

  @@map("bot_settings_kv")
}

model Feedback {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String // bug, feature, general
  subject   String
  message   String
  rating    Int? // 1-5 stars
  status    String   @default("pending") // pending, reviewed, resolved
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("feedback")
}

model Subscription {
  id                 String           @id @default(cuid())
  userId             String
  user               User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  planId             String
  plan               SubscriptionPlan @relation(fields: [planId], references: [id])
  status             String           @default("active") // active, cancelled, expired
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelAtPeriodEnd  Boolean          @default(false)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  @@index([status, currentPeriodEnd])
  @@map("subscriptions")
}

model SubscriptionPlan {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  price       Float
  currency    String   @default("USD")
  interval    String   @default("month") // month, year
  features    String? // JSON string of features
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  subscriptions Subscription[]

  @@map("subscription_plans")
}

model Payment {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount        Float
  currency      String   @default("USD")
  status        String   @default("pending") // pending, completed, failed, refunded
  paymentMethod String
  transactionId String?
  description   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("payments")
}

model ApiKey {
  id        String    @id @default(cuid())
  name      String
  key       String    @unique
  service   String // openai, stripe, etc.
  isActive  Boolean   @default(true)
  createdBy String
  createdAt DateTime  @default(now())
  lastUsed  DateTime?
  expiresAt DateTime?

  @@map("api_keys")
}

model Analytics {
  id         String   @id @default(cuid())
  metric     String
  value      Float
  category   String
  metadata   String? // JSON metadata
  recordedAt DateTime @default(now())

  @@map("analytics")
}

model Plugin {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  version     String
  author      String
  isActive    Boolean  @default(false)
  isPremium   Boolean  @default(false)
  price       Float?
  downloads   Int      @default(0)
  rating      Float    @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("plugins")
}

model ErrorLog {
  id        String   @id @default(cuid())
  level     String // error, warn, info
  message   String
  stack     String?
  userId    String?
  command   String?
  metadata  String? // JSON metadata
  createdAt DateTime @default(now())

  @@map("error_logs")
}

// Audit logging for compliance and security
model AuditLog {
  id         String   @id @default(cuid())
  eventType  String // Event type (user_login, admin_action, etc.)
  actor      String // Who performed the action
  actorId    String? // User ID of the actor
  action     String // Description of the action
  resource   String // Resource affected (user, system, payment, etc.)
  resourceId String? // ID of the affected resource
  details    String? // JSON details of the event
  riskLevel  String   @default("low") // low, medium, high, critical (String for SQLite)
  ipAddress  String? // IP address of the actor
  userAgent  String? // User agent string
  sessionId  String? // Session ID
  location   String? // Geographic location
  metadata   String? // Additional JSON metadata
  createdAt  DateTime @default(now())

  @@index([createdAt])
  @@index([actor])
  @@index([eventType])
  @@map("audit_logs")
}

// User violations and moderation history
model UserViolation {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  violationType String // hate_speech, violence, spam, harassment
  severity      String    @default("low") // low, medium, high, critical (String for SQLite)
  reason        String
  evidence      String? // JSON evidence data
  moderatorId   String?
  action        String // warn, ban, delete, none
  duration      Int? // ban duration in hours
  status        String    @default("pending") // pending, active, expired, appealed (String for SQLite)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  expiresAt     DateTime?

  @@index([userId, createdAt])
  @@index([violationType, severity])
  @@map("user_violations")
}

// System configuration settings
model SystemSetting {
  id              String   @id @default(cuid())
  category        String // general, security, api, database, email
  key             String
  value           String
  valueType       String   @default("string") // string, number, boolean, json
  description     String?
  isEncrypted     Boolean  @default(false)
  validationRules String? // JSON validation rules
  updatedBy       String
  updatedAt       DateTime @updatedAt

  @@unique([category, key])
  @@index([category, updatedAt])
  @@map("system_settings")
}

// Moderation queue for manual review
model ModerationQueue {
  id          String    @id @default(cuid())
  contentType String // message, image, file, profile
  contentId   String
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  content     String
  metadata    String? // JSON metadata
  priority    String    @default("normal") // low, normal, high, urgent
  status      String    @default("pending") // pending, approved, rejected, escalated (String for SQLite)
  moderatorId String?
  reviewedAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([status, priority])
  @@index([createdAt])
  @@map("moderation_queue")
}

// Admin user sessions
model AdminSession {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessionId    String   @unique
  ipAddress    String?
  userAgent    String?
  deviceInfo   String? // JSON device information
  lastActivity DateTime @default(now())
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  @@index([userId, expiresAt])
  @@index([sessionId])
  @@map("admin_sessions")
}

// Conversation memory for AI chatbots
model ConversationMemory {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessionId   String? // Optional session grouping
  messages    String // JSON array of message exchanges
  lastUpdated DateTime @updatedAt
  createdAt   DateTime @default(now())

  @@index([userId, lastUpdated])
  @@index([sessionId])
  @@map("conversation_memory")
}

// AI-generated content storage
model AIGeneratedContent {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String // image, text, voice_transcript, etc.
  prompt    String
  content   String // URL for images, text for responses
  metadata  String? // JSON metadata
  createdAt DateTime @default(now())

  @@index([userId, type, createdAt])
  @@map("ai_generated_content")
}

model ConversationEmbedding {
  id        String                      @id @default(uuid())
  userId    String
  user      User                        @relation(fields: [userId], references: [id], onDelete: Cascade)
  content   String // Original conversation snippet
  embedding Unsupported("vector(1536)") // For text-embedding-3-small
  timestamp DateTime                    @default(now())
  metadata  Json? // Topic, sentiment, intent classification

  @@index([userId])
  @@map("conversation_embeddings")
}

// Plans and Subscription Models
model Plan {
  id          String  @id @default(cuid())
  code        String  @unique // FREE, PRO, BUSINESS
  name        String
  description String?
  price       Int // cents
  currency    String  @default("USD")

  // Limits
  aiRequestsPerMonth Int @default(0)
  messagesPerDay     Int @default(100)
  mediaGensPerDay    Int @default(0)
  maxBots            Int @default(1)

  // Feature flags
  enableRAG           Boolean @default(false)
  enableVideo         Boolean @default(false)
  enableAIChat        Boolean @default(false)
  enableImageGen      Boolean @default(false)
  enableAdvancedTools Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  subscriptions TenantSubscription[]

  @@map("plans")
}

model UsageCounter {
  id         String   @id @default(cuid())
  tenantId   String
  period     String // YYYY-MM format
  aiRequests Int      @default(0)
  messages   Int      @default(0)
  mediaGens  Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, period])
  @@map("usage_counters")
}

// Bot Templates and Settings Models
model BotTemplate {
  id             String   @id @default(cuid())
  tenantId       String? // null for global templates
  name           String
  description    String?
  category       String // welcome, faq, leads, support, etc.
  welcomeMessage String?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  tenant    Tenant?               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  menuItems BotTemplateMenuItem[]

  @@map("bot_templates")
}

model BotTemplateMenuItem {
  id         String   @id @default(cuid())
  templateId String
  label      String
  actionType String // reply, link, command
  payload    String
  order      Int      @default(0)
  createdAt  DateTime @default(now())

  // Relations
  template BotTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@map("bot_template_menu_items")
}

model BotSettings {
  id             String   @id @default(cuid())
  botInstanceId  String   @unique
  welcomeMessage String?
  menuEnabled    Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  botInstance BotInstance           @relation(fields: [botInstanceId], references: [id], onDelete: Cascade)
  menuItems   BotSettingsMenuItem[]

  @@map("bot_settings")
}

model BotSettingsMenuItem {
  id         String   @id @default(cuid())
  settingsId String
  label      String
  actionType String // reply, link, command
  payload    String
  order      Int      @default(0)
  createdAt  DateTime @default(now())

  // Relations
  settings BotSettings @relation(fields: [settingsId], references: [id], onDelete: Cascade)

  @@map("bot_settings_menu_items")
}

// Simple Key-Value Store
model KeyValue {
  key   String @id
  value String

  @@map("key_value_store")
}
