version: '3.8'

# Smart WhatsDeX SaaS Deployment
# Services build in proper order with dependency waiting
# QR codes ONLY in web browser - never terminal!

services:
  # PostgreSQL Database (First to start)
  postgres:
    image: postgres:15-alpine
    container_name: whatsdx-postgres
    restart: always
    environment:
      POSTGRES_DB: whatsdx_saas
      POSTGRES_USER: whatsdx_user
      POSTGRES_PASSWORD: whatsdx_secure_2024
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    ports:
      - "5432:5432"
    networks:
      - whatsdx-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U whatsdx_user -d whatsdx_saas"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Redis Cache (Second to start)
  redis:
    image: redis:7-alpine
    container_name: whatsdx-redis
    restart: always
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    networks:
      - whatsdx-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  # Main WhatsDeX Bot (Third - waits for DB & Redis)
  whatsdx-bot:
    build:
      context: ..
      dockerfile: deployment/Dockerfile.smart
      args:
        - BUILD_MODE=production
    container_name: whatsdx-bot
    restart: always
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://whatsdx_user:whatsdx_secure_2024@postgres:5432/whatsdx_saas
      - REDIS_URL=redis://redis:6379
      - PORT=3000
      - PERSIST_SESSIONS=true
      - WEB_QR_ENABLED=true
      - PRINT_QR_IN_TERMINAL=false  # NEVER show QR in terminal!
      - AUTO_OPEN_BROWSER=false     # Let web dashboard handle this
    env_file:
      - ../.env.production.complete
    volumes:
      - sessions_data:/app/sessions    # Persistent WhatsApp sessions
      - uploads_data:/app/uploads
      - backups_data:/app/backups
      - logs_data:/app/logs
    ports:
      - "3000:3000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - whatsdx-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 15s
      timeout: 10s
      retries: 8
      start_period: 90s  # Give bot time to fully initialize

  # Web Dashboard (Fourth - waits for bot to be ready)
  whatsdx-web:
    build:
      context: ../web
      dockerfile: Dockerfile.smart
    container_name: whatsdx-web
    restart: always
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=http://localhost:3000
      - NEXT_PUBLIC_WS_URL=ws://localhost:3000
      - DATABASE_URL=postgresql://whatsdx_user:whatsdx_secure_2024@postgres:5432/whatsdx_saas
      - REDIS_URL=redis://redis:6379
      - NEXT_PUBLIC_AUTO_SHOW_QR=true
      - NEXT_PUBLIC_QR_REFRESH_INTERVAL=10000
    ports:
      - "3001:3000"
    depends_on:
      whatsdx-bot:
        condition: service_healthy  # Wait for bot to be fully ready
    networks:
      - whatsdx-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Smart Health Monitor & Auto-opener
  smart-launcher:
    image: alpine:latest
    container_name: whatsdx-launcher
    restart: "no"  # Run once then exit
    command: |
      sh -c "
        echo 'ðŸš€ Smart WhatsDeX Launcher Starting...'
        apk add --no-cache curl
        
        echo 'â³ Waiting for all services to be ready...'
        
        # Wait for bot to be fully ready
        while ! curl -f http://whatsdx-bot:3000/health; do
          echo 'â³ Waiting for bot service...'
          sleep 10
        done
        
        # Wait for web dashboard to be ready
        while ! curl -f http://whatsdx-web:3000/api/health; do
          echo 'â³ Waiting for web dashboard...'
          sleep 10
        done
        
        echo 'âœ… All services ready!'
        echo ''
        echo 'ðŸŽ‰ WhatsDeX SaaS is LIVE!'
        echo 'ðŸ“± Visit: http://localhost:3001'
        echo 'ðŸ”— QR Code will appear in your browser!'
        echo ''
        echo 'ðŸ“‹ Next steps:'
        echo '  1. Open http://localhost:3001 in your browser'
        echo '  2. Click \"Connect WhatsApp\"'
        echo '  3. Scan QR code shown on screen'
        echo '  4. âœ… Your bot will work forever!'
        echo ''
      "
    depends_on:
      whatsdx-web:
        condition: service_healthy
    networks:
      - whatsdx-network

  # Nginx Reverse Proxy (Optional - for production)
  nginx:
    image: nginx:alpine
    container_name: whatsdx-nginx
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/smart.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    depends_on:
      whatsdx-web:
        condition: service_healthy
    networks:
      - whatsdx-network
    profiles:
      - production  # Only start in production profile

  # Session Backup Service
  session-backup:
    image: alpine:latest
    container_name: whatsdx-backup
    restart: always
    command: |
      sh -c "
        apk add --no-cache tar gzip
        while true; do
          echo 'ðŸ’¾ Backing up sessions...'
          tar -czf /backups/sessions_$(date +%Y%m%d_%H%M%S).tar.gz -C /app sessions/ 2>/dev/null || echo 'No sessions to backup yet'
          find /backups -name '*.tar.gz' -mtime +7 -delete 2>/dev/null
          sleep 1800  # Backup every 30 minutes
        done
      "
    volumes:
      - sessions_data:/app/sessions:ro
      - backups_data:/backups
    depends_on:
      whatsdx-bot:
        condition: service_healthy
    networks:
      - whatsdx-network

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  sessions_data:      # Critical: Persistent WhatsApp sessions
    driver: local
  uploads_data:
    driver: local
  backups_data:
    driver: local
  logs_data:
    driver: local

networks:
  whatsdx-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16