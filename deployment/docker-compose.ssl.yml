# SSL-enabled Docker Compose override for WhatsDeX
# Use with: docker-compose -f production.docker-compose.yml -f docker-compose.ssl.yml up -d

services:
  # Enhanced nginx with SSL support
  nginx:
    volumes:
      - ./ssl:/etc/nginx/ssl:ro
      - ./nginx/nginx.prod.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl.conf:/etc/nginx/ssl.conf:ro
      - ./certbot/www:/var/www/certbot:ro
    environment:
      - SSL_ENABLED=true
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "https://localhost/health", "--no-check-certificate"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Certbot for Let's Encrypt certificate management
  certbot:
    image: certbot/certbot:latest
    container_name: whatsdex-certbot
    restart: "no"
    volumes:
      - ./ssl/certbot/conf:/etc/letsencrypt:rw
      - ./ssl/certbot/www:/var/www/certbot:rw
      - ./ssl/certbot/logs:/var/log/letsencrypt:rw
    environment:
      - CERTBOT_EMAIL=admin@yourdomain.com
    command: sh -c "trap exit TERM; while :; do certbot renew --quiet; sleep 12h & wait; done;"
    profiles:
      - ssl-auto-renewal

  # SSL certificate monitoring
  ssl-monitor:
    image: alpine:latest
    container_name: whatsdex-ssl-monitor
    restart: unless-stopped
    volumes:
      - ./ssl:/ssl:ro
      - ./ssl-monitor.sh:/monitor.sh:ro
    command: sh -c "trap exit TERM; while :; do /monitor.sh; sleep 86400 & wait; done;"
    environment:
      - ALERT_DAYS=30
      - WEBHOOK_URL=${SLACK_WEBHOOK_URL:-}
    profiles:
      - ssl-monitoring

volumes:
  ssl-certs:
    driver: local
  certbot-conf:
    driver: local
  certbot-www:
    driver: local